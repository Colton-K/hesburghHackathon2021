{% extends "base.html" %}

{% block content %}
<style>
 /* Customize the label (the container) */
 .container {
  display: block;
  position: relative;
  padding-left: 35px;
  margin-bottom: 12px;
  cursor: pointer;
  font-size: 22px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  background:rgb(221, 221, 221);
  padding: 20px;
  color: black;
}

/* Hide the browser's default checkbox */
.container input {
  position: absolute;
  opacity: 0;
  cursor: pointer;
  height: 0;
  width: 0;
}

/* Create a custom checkbox */
.checkmark {
  position: absolute;
  top: 20px;
  left: 20px;
  height: 25px;
  width: 25px;
  background-color: rgb(148, 148, 148);
}

/* On mouse-over, add a grey background color */
.container:hover input ~ .checkmark {
  background-color: #ccc;
}

/* When the checkbox is checked, add a blue background */
.container input:checked ~ .checkmark {
  background-color: #2196F3;
}

/* Create the checkmark/indicator (hidden when not checked) */
.checkmark:after {
  content: "";
  position: absolute;
  display: none;
}

/* Show the checkmark when checked */
.container input:checked ~ .checkmark:after {
  display: block;
}

/* Style the checkmark/indicator */
.container .checkmark:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
} 
</style>
<html>
    <h1>Dine Now page</h1>
</html>
  <div class="card-wrapper" id='setup-party'>
    <div class="card">
      <h1 class="center">Available Parties</h1>
      
      <div id="parties">
        <button id="parties_random" style="width: 100%">
            <h2>Join Random Party</h2>
        </button>
      </div>
    </div>

    <div class="card">
      <h1 class="center">Create Party</h1>
      <form name="create_party" id="create_party">
          
        <input id="party-name-entry" type="text" name="name" class="field"
        placeholder="Name (optional)">

        <label class="container"> Public
            <input type="checkbox" id="make_public">
            <span class="checkmark"></span>
        </label>

        <label class="container"> Auto Accept
            <input type="checkbox" id="auto_join">
            <span class="checkmark"></span>
        </label>

        <label id="add_groups">Add Groups</label>

        <input type="submit" value="Create Party" class="btn">
      
      </form>
    </div>
  </div>

  <div id='wait-on-party' style="display: none">
    <h1 id='wait-on-party-title'></h1>
  </div>

    <div id='manage-party' style="display: none">
        <h1>Managing Party</h1>
        <h2 id='party-count-manager'>1 Member</h2>
        <div class="card-wrapper">
            <div id='member-requests' class='card'>
                <h2 style='padding-top: 40px;'>Members and Join Requests</h2>
            </div>
            <div id='party-chat-manager' class='card'>
                <h2 style='padding-top: 40px;'>Party Chat</h2>
            </div>
        </div>
    </div>

    <div id='party-joined' style="display: none">
        <h1 id='party-joined-title'></h1>
        <h2 id='party-count'></h2>
        <div class="card-wrapper">
            <div id='party-chat' class='card'>
                <h2 style='padding-top: 40px;'>Party Chat</h2>
            </div>
        </div>
    </div>

<script>
var parties = [];
var groups = [];
var selectedParty = null;
var partyOwner = false;

var _partyName = null;
function partyName() {
    if (_partyName) {
        return _partyName;
    }
    if (selectedParty) {
        for (var i = 0; i < parties.length; i++) {
            if (parties[i].party_id == selectedParty) {
                return parties[i].name;
            }
        }
    }
    return "Party";
}

function waitOnParty(partyId, message) {
    selectedParty = partyId;
    
    document.getElementById('setup-party').style.display = "none";
    document.getElementById('wait-on-party').style.display = "inherit";
    document.getElementById('wait-on-party-title').innerHTML = message;
}

function manageParty(partyId) {
    document.getElementById('setup-party').style.display = "none";
    document.getElementById('manage-party').style.display = "inherit";
}

function attemptJoinParty(partyId) {
    var data = 'party_id=' + partyId;
    ajaxOnSuccess('/user/join_party', (resp) => {
        if (resp.result == 'success') {
            waitOnParty(partyId, resp.message);
        }
        else {
            console.log(resp.error);
        }
    }, data);
}

function ajaxOnSuccess(endpoint, func, data) {
    if (!data) {
        data = '';
    }

    $.ajax({
        url: endpoint,
        type: "POST",
        data: data,
        dataType: "json",
        success: function(resp) {
            func(resp);
        },
        error: function(resp) {
            console.log(resp, 'fail');
        }
    });
}

function addPartyInfo(party) {
    var button = document.createElement('button');

    var partyLoc = party.location;

    if (party.name == "Party") {
        button.innerHTML = "<h2>" + party.name +  "with "
            + party.n_members + " member(s)<h2>";
    }
    else {
        button.innerHTML = "<h2>" + party.name +  " ("
            + party.n_members + " member(s))<h2>";
    }
    button.style.width = "100%";
    button.style.marginTop = "10px";
    button.id = party.party_id;
    button.onclick = (e) => {
        var partyId = e.target.id;
        selectedParty = partyId;
        attemptJoinParty(partyId);
    }

    document.getElementById('parties').appendChild(button);
}

ajaxOnSuccess('/user/get_parties', function(resp) {
    parties = resp;
    for (var i = 0; i < parties.length; i++) {
        addPartyInfo(parties[i]);
    }
});

ajaxOnSuccess('/user/getGroups', function(resp) {
    groups = resp;

    for (var i = 0; i < groups.length; i++) {
        var group = groups[i];

        var groupElem = document.createElement('label');
        groupElem.classList.add("container");
        groupElem.innerHTML = group.name
        + ` <input type="checkbox" ` + "id=" + group.group_id + ` +>
            <span class="checkmark"></span>
        </label>`;

        var refNode = document.getElementById('add_groups');
        refNode.parentNode.insertBefore(groupElem, refNode.nextSibling);
    }
});

$("form[name=create_party").submit(function(e) {

    e.preventDefault();
    e.stopImmediatePropagation();


    var data = "public=" + document.getElementById('make_public').value;
    data += "&auto_join=" + document.getElementById('auto_join').value;

    var partyName_ = document.getElementById('party-name-entry').value;
    if (partyName_ == "") {
        partyName_ = "Party"
    }
    data += "&name=" + partyName_;


    for (var i = 0; i < groups.length; i++) {
        if (document.getElementById(groups[i].group_id).value == "on") {
            data += "&" + groups[i].group_id + "=true";
        }
    }

    $.ajax({
        url: "/user/create_party",
        type: "POST",
        data: data,
        dataType: "json",
        success: function(resp) {
            if (resp.result == 'success') {
                partyName = partyName_;
                selectedParty = resp.party_id;
                partyOwner = true;
                manageParty(resp.party_id);
            }
            e.preventDefault();
        },
        error: function(resp) {
            e.preventDefault();
        }
    });
});

function acceptUser(e) {
    var user_id = e.target.id.slice(1);
    var data = 'user_id=' + user_id + '&party_id=' + selectedParty;
    ajaxOnSuccess('/user/accept_user', () => {
        document.getElementById('r' + user_id).remove();
    }, data);
}

function declineUser(e) {
    var user_id = e.target.id.slice(1);
    var data = 'user_id=' + user_id + '&party_id=' + selectedParty;
    ajaxOnSuccess('/user/decline_user', (resp) => {
        console.log(resp);
        document.getElementById('r' + user_id).remove();
    }, data);
}

registerListener('party_request', (info) => {

    var id = info.user_id;
    var node = document.createElement('div');
    node.innerHTML = `
        <h2>` + info.name + `<h2>
        <button id="a`+id+`" style='margin-left : 20px'>Accept</button>
        <button id="d`+id+`">Decline</button>
    `;
    node.style.padding = "10px";
    node.style.marginTop = "20px";
    node.style.background = '#d0f0d0';
    node.id = 'r' + id;

    document.getElementById('member-requests').appendChild(node);
    document.getElementById('a' + id).onclick = acceptUser;
    document.getElementById('d' + id).onclick = declineUser;
});

registerListener('party_accept', (info) => {
    document.getElementById('wait-on-party').style.display = "none";
    document.getElementById('party-joined').style.display = "inherit";

    var title = document.getElementById('wait-on-party');
    if (partyName() != "Party") {
        title = "You have joined " + partyName() + "!"
    }
    else {
        title = "You have joined a party!"
    }
});

registerListener('party_decline', (info) => {
    window.location.href = "/dineNow";
});

registerListener('party_created', (info) => {
    addPartyInfo(info);
    parties.push(info);
});

registerListener('party_new_member', (info) => {
    var nMembers = info.n_members;

    document.getElementById('party-count').innerHTML = nMembers + ' Members';
    document.getElementById('party-count-manager').innerHTML = nMembers + ' Members';
});



</script>

{% endblock %}
